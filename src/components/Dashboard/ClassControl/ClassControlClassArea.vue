<script setup lang="ts">
import ShareWebsiteModal from "../../../components/Modals/ShareWebsiteModal.vue";
import ShareApplicationModal from "@/components/Modals/ShareApplicationModal.vue";
import ShareMediaModal from "@/components/Modals/ShareMediaModal.vue";
import ClassControlSessionArea from "./ClassControlSessionArea.vue";
import * as REQUESTS from "../../../constants/_requests";
import { ref, watch } from "vue";
import { useDashboardStore } from "@/stores/dashboardStore";

const dashboardPinia = useDashboardStore();
const loading = ref(false);
const locked = ref(false);

async function screenControl() {
  loading.value = true;
  await new Promise(res => setTimeout(res, 500));
  locked.value = !locked.value;
  loading.value = false;
  dashboardPinia.requestAction({ type: REQUESTS.SCREENCONTROL, action: locked.value ? REQUESTS.BLOCK : REQUESTS.UNBLOCK }, REQUESTS.WEB);
  dashboardPinia.requestAction({ type: REQUESTS.SCREENCONTROL, action: locked.value ? REQUESTS.BLOCK : REQUESTS.UNBLOCK }, REQUESTS.MOBILE);
}

//Reference to the separate media modals to open them externally
const websiteRef = ref<InstanceType<typeof ShareWebsiteModal> | null>(null)
function openWebsiteModal() {
  websiteRef.value?.openModal();
}

const applicationRef = ref<InstanceType<typeof ShareApplicationModal> | null>(null)
function openApplicationModal() {
  applicationRef.value?.openModal();
}

//Determine which modal should be displayed based on the follower numbers
const showMediaModal = ref(true)
const showWebsiteModal = ref(false)
const showMobileModal = ref(false)

watch([dashboardPinia.webFollowers, dashboardPinia.mobileFollowers], ([newWebFollowers, newMobileFollowers]) => {
  if (newWebFollowers.length > 0 && newMobileFollowers.length > 0) {
    setModals(true, false, false);
  } else if (newWebFollowers.length > 0 && newMobileFollowers.length === 0) {
    setModals( false, true, false);
  } else if (newWebFollowers.length === 0 && newMobileFollowers.length > 0) {
    setModals( false, false, true);
  } else {
    setModals(true, false, false);
  }
})

function setModals(media: boolean, website: boolean, mobile: boolean) {
  showMediaModal.value = media
  showWebsiteModal.value = website
  showMobileModal.value = mobile
}
</script>

<template>
  <div class="mt-14 px-5 lg:px-10 sticky top-0 w-full py-4 bg-panel-background">
    <div class="flex flex-row justify-between items-center">
      <p class="text-3xl font-medium">{{ dashboardPinia.user.displayName }}'{{ dashboardPinia?.user?.displayName?.endsWith('s') ? '' : 's' }} Class</p>
      <ClassControlSessionArea />
    </div>

    <!--Action Area-->
    <div class="mt-8 flex child:mr-4">

      <!--Determine modal type from follower numbers-->
      <div :class="{'hidden': false}">
        <ShareMediaModal @webModal="openWebsiteModal" @appModal="openApplicationModal" />
      </div>
      <div :class="{'hidden': true}">
        <ShareWebsiteModal ref="websiteRef" />
      </div>
      <div :class="{'hidden': true}">
        <ShareApplicationModal ref="applicationRef" />
      </div>

      <button :class="{
          'w-56 h-9 flex justify-center font-medium items-center text-white': true,
          'bg-navy-side-menu hover:bg-navy-hover-session-button': locked,
          'bg-blue-500 hover:bg-blue-400': !locked
          }"
          :disabled="loading"
          v-on:click="screenControl();"
      >
        <span v-if="loading" class="lds-dual-ring-screen h-4 w-4 mr-3"></span>

        <span v-else class="flex flex-row place-items-center">
          <img v-if="locked" class="w-4 h-4 mr-3" src="/src/assets/img/session-icon-unlock.svg" alt="Icon"/>
          <img v-else class="w-4 h-4 mr-3" src="/src/assets/img/session-icon-lock.svg" alt="Icon"/>
          <span class="text-base">
            {{locked ? 'Unlock screens' : 'Lock screens'}}
          </span>
        </span>
      </button>
    </div>
  </div>
</template>

<style>
.lds-dual-ring-screen {
  display: inline-block;
  width: 20px;
  height: 20px;
}
.lds-dual-ring-screen:after {
  content: " ";
  display: block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #ffffff;
  border-color: #ffffff transparent #ffffff transparent;
  animation: lds-dual-ring-screen 1.2s linear infinite;
}
@keyframes lds-dual-ring-screen {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
</style>